# 预期

一个天气数据平台，提供数据为其他研究服务

期望达到的功能点：

1：普通用户及管理员管理，天气数据需要经过加密处理，用户通过身份信息注册后拿到key才可以访问，管理员有权管理普通用户，包括添加用户修改密码等操作。

2：数据需要能提供MCP服务，其他ai可以直接调用

3：AI-agent需要可以调用爬取数据的接口对数据进行更新

#### . 关于“数据加密”的纠偏 (针对功能点1)

- **问题：** 你提到“天气数据经过加密处理”。
- **建议：** **不要加密数据库里的天气数值本身**（如把“25℃”加密成乱码）。因为如果你加密了具体数值，你的 SQL 查询（比如 `SELECT * FROM weather WHERE temp > 30`）将无法执行，分析效率极低。
- **正确做法：**
  - **加密传输：** 强制使用 HTTPS。
  - **敏感信息加密：** 只加密用户的密码（Hash）、API Key 的 Secret。
  - **数据脱敏：** 如果是卖数据，给未付费用户返回模糊数据（如只显示“高温”，不显示“38度”）。
  - **访问控制（Rate Limiting）：** 这才是管理员管理的重点。限制每个 API Key 每分钟只能调用 60 次，防止有人把你的服务器爬挂。

#### 2. AI Agent 的角色不仅是“调用接口” (针对功能点3)

- **问题：** 你希望 Agent 调用接口更新数据。如果只是“每天早上 8 点更新数据”，这不需要 AI Agent，一个简单的 **Cron Job（定时任务）** 代码就能写死，用 AI 是“杀鸡用牛刀”，会被老师质疑。
- **建议（让 Agent 变聪明）：** 让 Agent 做**“自适应调度”**或**“异常修复”**。
  - **场景：** Agent 检测到最近是“台风季”（通过分析数据波动），它自主决定：“原来每天爬 1 次太慢了，我决定接下来 3 天每小时爬 1 次”，并调用修改配置的接口。这才是体现 AI 智能的地方。

#### 3. 遗漏点：可视化 Dashboard

- 管理员和用户需要一个界面。虽然 MCP 是给 AI 用的，但人类管理员需要一个网页后台来看：
  - 当前有多少 Key 在跑？
  - 爬虫是不是挂了？
  - 简单的天气图表展示。



# 具体搭建

## 先搭建FastAPI框架

让gemini分析项目，并给出提示词

```
你是一位资深的 Python 后端架构师。我正在开发一个天气大数据服务平台，我已经有了爬虫脚本和底层数据，现在需要你帮我搭建核心的 FastAPI 后端架构。

项目背景：
这个后端将作为核心 API 网关，既要给前端 Dashboard 提供管理功能，又要对外（用户和 AI Agent）提供数据服务。

技术栈要求：

框架： FastAPI (全异步 async/await)
数据库 ORM： SQLAlchemy (AsyncSession) + PostgreSQL
数据验证： Pydantic v2
安全： Passlib (密码哈希), PyJWT (登录认证)
请帮我实现以下核心需求：

数据库模型设计 (models.py)：

User 表：包含 id, username, hashed_password, role (区分管理员/普通用户), is_active。
APIKey 表：用于对外鉴权。包含 id, user_id (外键), access_key (如 "sk-xxx"), remaining_quota (剩余调用次数), is_active。
SystemConfig 表：用于 AI Agent 动态调整策略。包含 key (如 "crawler_interval"), value。
注意：暂不需要创建 WeatherData 模型，稍后我会手动集成现有数据表。
安全与认证逻辑 (core/security.py)：

实现 JWT 登录：用于管理员和用户登录网页后台。
实现 API Key 中间件/依赖：创建一个 verify_api_key 依赖函数，用于检查请求 Header 中的 X-API-KEY 是否存在、有效且有剩余额度。这是用于 /weather 接口的。
API 路由模块 (routers/)：

auth.py：用户注册、登录 (生成 JWT)。
admin.py：(仅管理员可用) 管理用户、为用户生成新的 API Key。
weather.py：(需 API Key 验证) 获取天气数据的接口，暂时返回 Mock 数据即可。
agent.py：(仅管理员或系统 Key 可用) 供 AI Agent 调用的接口，用于修改 SystemConfig 中的配置（例如更新爬虫频率）。
工程结构：

请规划一个清晰、模块化的文件目录结构 (如 app/core, app/db, app/routers 等)。
输出要求：

首先展示推荐的文件目录结构树。
然后依次提供 main.py, models.py, schemas.py (Pydantic 模型) 以及 security.py 的核心代码实现。
```



```
MCP-Agent-WeartherData/
├── data/
│   ├── weather_data_fast.csv
│   └── weather_data.py
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPI 主入口
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py              # 配置管理 (环境变量、密钥等)
│   │   ├── security.py            # JWT + API Key 认证逻辑
│   │   └── dependencies.py        # 全局依赖注入 (数据库会话等)
│   ├── db/
│   │   ├── __init__.py
│   │   ├── database.py            # 数据库连接 (AsyncSession)
│   │   └── base.py                # Base 模型导入汇总
│   ├── models/
│   │   ├── __init__.py
│   │   └── models.py              # SQLAlchemy ORM 模型
│   ├── schemas/
│   │   ├── __init__.py
│   │   └── schemas.py             # Pydantic 数据验证模型
│   └── routers/
│       ├── __init__.py
│       ├── auth.py                # 用户注册/登录 (JWT)
│       ├── admin.py               # 管理员功能
│       ├── weather.py             # 天气数据查询 (需 API Key)
│       └── agent.py               # AI Agent 配置调整
├── requirements.txt
└── # 🌤️ 天气大数据服务平台 - FastAPI 后端

## 📋 项目简介

这是一个基于 FastAPI 构建的天气大数据服务平台后端，提供用户管理、API Key 认证、天气数据查询以及 AI Agent 配置管理功能。

## 🏗️ 技术栈

- **框架**: FastAPI (异步 async/await)
- **数据库**: PostgreSQL + SQLAlchemy (AsyncSession)
- **数据验证**: Pydantic v2
- **安全**: Passlib (密码哈希) + PyJWT (JWT 认证)
- **服务器**: Uvicorn

## 📁 项目结构

```

